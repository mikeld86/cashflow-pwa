<!doctype html>
<html lang="en" data-theme="light" data-accent="green">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cash Flow</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0fa836" />
  <link rel="preload" as="style" href="styles.css?v=20250812081433">
  <link rel="stylesheet" href="styles.css?v=20250812081433" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <header class="app-header">
      <h1 class="app-title">Cash Flow</h1>
      <div class="badges">
        <span id="saveState" class="pill badge">Saved</span>
        <span id="authStatus" class="pill badge muted">Signed out</span>
      </div>
      <div class="toolbar">
        <div class="left-group">
          <button class="pill" data-goto="home" title="Home">Home</button>
          <button class="pill" data-goto="summary">Summary</button>
          <button class="pill" data-goto="edit">Income &amp; Expenses</button>
        </div>
        <div class="right-group">
          <button class="pill" id="themeToggle" title="Toggle dark mode">ðŸŒ™ Light</button>
          <label class="select-pill">
            <select id="accentPicker" title="Accent colour">
              <option value="green">Green</option>
              <option value="teal">Teal</option>
              <option value="blue">Blue</option>
              <option value="purple">Purple</option>
              <option value="amber">Amber</option>
            </select>
          </label>
          <button class="pill" id="authBtn">Sign in</button>
        </div>
      </div>
    </header>

    <section class="card active" data-view="home">
      <div class="card-head">
        <div class="title-row">
          <h2 class="title accent">Current Cash on Hand</h2>
          <button class="pill ghost" id="exportCsvHome">Export CSV</button>
        </div>
      </div>
      <div class="landing-head">
        <div id="homeCash" class="mono amount">$0.00</div>
      </div>

      <div class="box">
        <div class="title big">SUMMARY</div>
        <button class="btn" data-goto="summary" aria-label="Open Summary">Open</button>

        <div class="title big" style="margin-top:28px">INCOME &amp; EXPENSES</div>
        <button class="btn" data-goto="edit" aria-label="Open Income & Expenses">Open</button>
      </div>
    </section>

    <section class="card" data-view="summary">
      <div class="card-head">
        <div class="title-row">
          <h2 class="title accent">Summary</h2>
          <button class="pill ghost" id="exportCsvSummary">Export CSV</button>
        </div>
      </div>
      <div class="table" style="margin-top:12px">
        <table>
          <thead><tr><th colspan="3">CASH ON HAND</th></tr></thead>
          <tbody>
            <tr><td class="strong">Cash on hand</td><td class="right">$</td><td class="right mono" id="sumCashOnHand">$0.00</td></tr>
            <tr><td class="strong">Income</td><td class="right">$</td><td class="right mono" id="sumIncThis">$0.00</td></tr>
            <tr><td class="strong">Expenses</td><td class="right">$</td><td class="right mono neg" id="sumExpThis">$0.00</td></tr>
            <tr class="hl"><td class="strong">REMAINING</td><td class="right">$</td><td class="right mono" id="remainThis">$0.00</td></tr>

            <tr class="band"><td colspan="3">NEXT WEEK</td></tr>
            <tr><td class="strong">Cash on hand</td><td class="right">$</td><td class="right mono" id="sumCashNext">$0.00</td></tr>
            <tr><td class="strong">Income</td><td class="right">$</td><td class="right mono" id="sumIncNext">$0.00</td></tr>
            <tr><td class="strong">Expenses</td><td class="right">$</td><td class="right mono neg" id="sumExpNext">$0.00</td></tr>
            <tr class="hl"><td class="strong">REMAINING</td><td class="right">$</td><td class="right mono" id="remainNext">$0.00</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="card" data-view="edit">
      <div class="card-head">
        <div class="title-row">
          <h2 class="title accent">Income & Expenses</h2>
          <button class="pill ghost" id="exportCsvEdit">Export CSV</button>
        </div>
      </div>

      <div class="sticky-bar">
        <span class="muted" style="margin-right:auto">Quick add rows:</span>
        <button class="pill mini" id="addCashRowTop">+ Cash</button>
        <button class="pill mini" id="addIncomeThisTop">+ Income (this)</button>
        <button class="pill mini" id="addIncomeNextTop">+ Income (next)</button>
        <button class="pill mini" id="addThisRowTop">+ Expense (this)</button>
        <button class="pill mini" id="addNextRowTop">+ Expense (next)</button>
      </div>

      <div class="grid">
        <div>
          <div class="row between">
            <h3 class="section-title">Cash Flow</h3>
            <button class="pill mini" id="addCashRow">+ Row</button>
          </div>
          <div class="table"><table><tbody id="cashOnHandTable"></tbody>
            <tfoot><tr class="band"><td>CASH ON HAND</td><td class="right mono" id="cashOnHandTotal">$0.00</td></tr></tfoot>
          </table></div>

          <div class="row between" style="margin-top:16px">
            <h3 class="section-title">Income</h3>
            <div class="row">
              <button class="pill mini" id="addIncomeThis">+ This</button>
              <button class="pill mini" id="addIncomeNext">+ Next</button>
            </div>
          </div>
          <div class="table"><table><tbody id="incomeTable"></tbody>
            <tfoot><tr class="band"><td>TOTAL INCOME</td><td class="right mono" id="incomeTotal">$0.00</td></tr></tfoot>
          </table></div>
        </div>

        <div>
          <div class="row between">
            <h3 class="section-title">Outgoing â€“ This week</h3>
            <button class="pill mini" id="addThisRow">+ Row</button>
          </div>
          <div class="table"><table><tbody id="outThisTable"></tbody>
            <tfoot><tr class="band"><td>This week</td><td class="right mono" id="expThisTotal">$0.00</td></tr></tfoot>
          </table></div>

          <div class="row between" style="margin-top:16px">
            <h3 class="section-title">Outgoing â€“ Next week</h3>
            <button class="pill mini" id="addNextRow">+ Row</button>
          </div>
          <div class="table"><table><tbody id="outNextTable"></tbody>
            <tfoot><tr class="band"><td>Next week</td><td class="right mono" id="expNextTotal">$0.00</td></tr></tfoot>
          </table></div>
        </div>
      </div>
    </section>
  </div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const supa = window.supabase.createClient('https://heeewuebfqimpwltpoik.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhlZWV3dWViZnFpbXB3bHRwb2lrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NzYyMDMsImV4cCI6MjA3MDU1MjIwM30.PB9Nu-ASlsinZWu4ApYwVPD4OBPINjpmJQPpfXideHY');

  const theme = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  document.documentElement.setAttribute('data-theme', theme);
  $('#themeToggle').textContent = theme==='dark' ? 'â˜€ï¸ Light' : 'ðŸŒ™ Light';
  $('#themeToggle').onclick = () => { const next = document.documentElement.getAttribute('data-theme')==='dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', next); localStorage.setItem('theme', next); $('#themeToggle').textContent = next==='dark' ? 'â˜€ï¸ Light' : 'ðŸŒ™ Light'; };

  const accent = localStorage.getItem('accent') || 'green';
  document.documentElement.setAttribute('data-accent', accent);
  $('#accentPicker').value = accent;
  $('#accentPicker').onchange = e => { document.documentElement.setAttribute('data-accent', e.target.value); localStorage.setItem('accent', e.target.value); };

  $$('.pill,[data-goto].btn').forEach(b => { const v=b.dataset.goto; if(!v) return;
    b.onclick = () => { $$('.card[data-view]').forEach(x=>x.classList.remove('active')); document.querySelector(`[data-view="${v}"]`).classList.add('active'); calc(); };
  });

  const DEFAULT = { cashOnHand:[{label:'Cash',amount:455},{label:'Cash',amount:0},{label:'Bank',amount:2048.6},{label:'Bank',amount:0},{label:'Unpaid',amount:100},{label:'Other Income',amount:963.5}], income:[{label:'Proj. Sales (this week)',bucket:'this',amount:350},{label:'Proj. Sales (Next week)',bucket:'next',amount:4550}], expensesThis:[{label:'Supply Chain',amount:2000},{label:'Other',amount:750}], expensesNext:[{label:'Rent',amount:1300},{label:'Car',amount:500},{label:'Electricity',amount:50},{label:'Phone',amount:300},{label:'Other',amount:0},{label:'Other',amount:0}] };
  let state = load() || DEFAULT;

  const fmt = n => Number(n||0).toLocaleString(undefined,{style:'currency',currency:'AUD',maximumFractionDigits:2});
  const num = v => Number(v||0);
  const badge = $('#saveState'); let timer=null;

  function save() { localStorage.setItem('cashflow-pwa', JSON.stringify(state)); badge.textContent='Saved'; }
  function load() { try { return JSON.parse(localStorage.getItem('cashflow-pwa')||''); } catch { return null; } }
  function saveSoon() { clearTimeout(timer); badge.textContent='Savingâ€¦'; timer=setTimeout(save, 250); }

  function row(obj, onChange){ const tr=document.createElement('tr'); tr.innerHTML=`<td><input type="text" value="${obj.label||''}"></td><td class="right"><input type="number" step="0.01" value="${obj.amount??''}"></td>`; const [label, amt]=tr.querySelectorAll('input'); label.oninput=e=>{obj.label=e.target.value;saveSoon();}; amt.oninput=e=>{obj.amount=e.target.value;onChange();}; return tr; }

  function render(){ const cashT=$('#cashOnHandTable'); cashT.innerHTML=''; state.cashOnHand.forEach(r=>cashT.appendChild(row(r,calc))); const incT=$('#incomeTable'); incT.innerHTML=''; state.income.forEach(r=>incT.appendChild(row(r,calc))); const outThis=$('#outThisTable'); outThis.innerHTML=''; state.expensesThis.forEach(r=>outThis.appendChild(row(r,calc))); const outNext=$('#outNextTable'); outNext.innerHTML=''; state.expensesNext.forEach(r=>outNext.appendChild(row(r,calc))); calc(); }

  function calc(){ const cash=state.cashOnHand.reduce((s,x)=>s+num(x.amount),0); const incThis=state.income.filter(x=>x.bucket!=='next').reduce((s,x)=>s+num(x.amount),0); const incNext=state.income.filter(x=>x.bucket==='next').reduce((s,x)=>s+num(x.amount),0); const expThis=state.expensesThis.reduce((s,x)=>s+num(x.amount),0); const expNext=state.expensesNext.reduce((s,x)=>s+num(x.amount),0); const availThis=cash+incThis; const remainThis=availThis-expThis; const carry=Math.max(0,remainThis); const availNext=carry+incNext; const remainNext=availNext-expNext; $('#homeCash').textContent=fmt(cash); $('#sumCashOnHand').textContent=fmt(cash); $('#sumIncThis').textContent=fmt(incThis); $('#sumExpThis').textContent=fmt(expThis); $('#remainThis').textContent=fmt(remainThis); $('#sumCashNext').textContent=fmt(carry); $('#sumIncNext').textContent=fmt(incNext); $('#sumExpNext').textContent=fmt(expNext); $('#remainNext').textContent=fmt(remainNext); $('#cashOnHandTotal').textContent=fmt(cash); $('#incomeTotal').textContent=fmt(incThis+incNext); $('#expThisTotal').textContent=fmt(expThis); $('#expNextTotal').textContent=fmt(expNext); saveSoon(); }

  const addIncome=b=>{state.income.push({label:'Income',bucket:b,amount:0});render();};
  const addCash=()=>{state.cashOnHand.push({label:'Other',amount:0});render();};
  const addThis=()=>{state.expensesThis.push({label:'Other',amount:0});render();};
  const addNext=()=>{state.expensesNext.push({label:'Other',amount:0});render();};
  $('#addCashRowTop').onclick=addCash; $('#addIncomeThisTop').onclick=()=>addIncome('this'); $('#addIncomeNextTop').onclick=()=>addIncome('next'); $('#addThisRowTop').onclick=addThis; $('#addNextRowTop').onclick=addNext;
  $('#addCashRow').onclick=addCash; $('#addIncomeThis').onclick=()=>addIncome('this'); $('#addIncomeNext').onclick=()=>addIncome('next'); $('#addThisRow').onclick=addThis; $('#addNextRow').onclick=addNext;

  const exportCsv = () => { const csv=s=>`"$\{String(s||'').replace(/"/g,'""')}"`; const n=v=>Number(v||0); const lines=['Section,Label,Bucket,Amount']; state.cashOnHand.forEach(r=>lines.push(['Cash on Hand',csv(r.label),'',n(r.amount)].join(','))); state.income.forEach(r=>lines.push(['Income',csv(r.label),r.bucket,n(r.amount)].join(','))); state.expensesThis.forEach(r=>lines.push(['Expenses',csv(r.label),'this',n(r.amount)].join(','))); state.expensesNext.forEach(r=>lines.push(['Expenses',csv(r.label),'next',n(r.amount)].join(','))); const blob=new Blob([lines.join('\n')],{type:'text/csv'}); const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:'cashflow.csv'}); a.click(); URL.revokeObjectURL(a.href); };
  ['#exportCsvHome','#exportCsvSummary','#exportCsvEdit'].forEach(id=>document.querySelector(id).onclick=exportCsv);

  if ('serviceWorker' in navigator) window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  render();
})();
</script>
</body>
</html>